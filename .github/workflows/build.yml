name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS ARM64
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows x64

    runs-on: ${{ matrix.platform }}
    name: Build ${{ matrix.name }}

    steps:
      # -------------------------
      # åŸºç¡€ç¯å¢ƒ
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # -------------------------
      # å‰ç«¯ä¾èµ–
      # -------------------------
      - name: Install frontend dependencies
        run: pnpm install

      # -------------------------
      # æ„å»º + å‘å¸ƒ Release
      # -------------------------
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'WLZJ Match Downloader ${{ github.ref_name }}'
          releaseDraft: false
          prerelease: false
          args: --target ${{ matrix.target }}

      # -------------------------
      # ğŸ” ç”Ÿæˆ .sig ç­¾åæ–‡ä»¶ï¼ˆç”¨äºè‡ªåŠ¨æ›´æ–°ï¼‰
      # -------------------------
      - name: Install Tauri CLI for signing
        if: matrix.platform != 'ubuntu-22.04'
        run: cargo install tauri-cli --version "^2.0.0"

      - name: Generate .sig signature files
        if: matrix.platform != 'ubuntu-22.04'
        shell: bash
        env:
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: |
          set -e
          
          echo "ğŸ” Looking for installer files..."
          
          TARGET="${{ matrix.target }}"
          BUNDLE_DIR="src-tauri/target/${TARGET}/release/bundle"
          
          # æ ¹æ®å¹³å°æŸ¥æ‰¾å¯¹åº”çš„æ›´æ–°åŒ… (Tauri æ›´æ–°å™¨è¦æ±‚å¿…é¡»æ˜¯å‹ç¼©æ ¼å¼)
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            PATTERN="*.app.tar.gz"
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            # Windows: å°è¯•æŸ¥æ‰¾ .zip
            # å¦‚æœæ‰¾ä¸åˆ° .zipï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢æ‰‹åŠ¨å‹ç¼© .msi
            PATTERN="*.zip"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ .zipï¼Œå¦‚æœæ²¡æœ‰åˆ™æŸ¥æ‰¾ .msi å¹¶å‹ç¼©
            if [ -z "$(find "$BUNDLE_DIR" -type f -name "*.zip")" ]; then
                echo "âš ï¸ No .zip found for Windows, trying to compress .msi..."
                MSI_FILE=$(find "$BUNDLE_DIR" -type f -name "*.msi" | head -n 1)
                if [ -n "$MSI_FILE" ]; then
                    echo "ğŸ“¦ Compressing $MSI_FILE to zip..."
                    # ä½¿ç”¨ PowerShell å‹ç¼© (Windows ç¯å¢ƒ) æˆ–è€… tar
                    # ç”±äºæ˜¯åœ¨ git bash ä¸­è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ tar
                    # æ³¨æ„ï¼šTauri updater æœŸæœ› zip å†…ç›´æ¥åŒ…å« msiï¼Œè¿˜æ˜¯ç›®å½•ç»“æ„ï¼Ÿé€šå¸¸æ˜¯ç›´æ¥åŒ…å«ã€‚
                    # ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç”Ÿæˆä¸ msi åŒåçš„ zip
                    ZIP_FILE="${MSI_FILE}.zip"
                    # ä½¿ç”¨ 7z (Windows runner é€šå¸¸é¢„è£…) æˆ–è€… PowerShell
                    # è¿™é‡Œå°è¯•ç”¨ powershell Compress-Archive
                    powershell -Command "Compress-Archive -Path '${MSI_FILE}' -DestinationPath '${ZIP_FILE}'"
                    echo "âœ… Created $ZIP_FILE"
                else
                    echo "âŒ No .msi found either!"
                fi
            fi
          fi
          
          echo "ğŸ“‚ Searching in: $BUNDLE_DIR"
          echo "ğŸ” Pattern: $PATTERN"
          
          # æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„æ–‡ä»¶
          find "$BUNDLE_DIR" -type f -name "$PATTERN" | while read -r INSTALLER; do
            echo ""
            echo "ğŸ“¦ Found: $INSTALLER"
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ .sig æ–‡ä»¶
            if [ -f "${INSTALLER}.sig" ]; then
              echo "âœ… Signature already exists: ${INSTALLER}.sig"
            else
              echo "ğŸ” Generating signature..."
              
              # ç”Ÿæˆç­¾å - æ ¹æ®å¯†ç æ˜¯å¦ä¸ºç©ºå†³å®šæ˜¯å¦ä¼ é€’ --password å‚æ•°
              # ç”Ÿæˆç­¾å
              # ç¯å¢ƒå˜é‡ TAURI_PRIVATE_KEY å’Œ TAURI_KEY_PASSWORD å·²åœ¨ step çº§åˆ«å®šä¹‰
              
              # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’æ•æ„Ÿä¿¡æ¯ï¼Œé¿å… Shell æ’å€¼å¯¼è‡´çš„æ ¼å¼é—®é¢˜
              # å°†ç§é’¥å’Œå¯†ç å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¾› cargo tauri ä½¿ç”¨ (å¦‚æœå®ƒæ”¯æŒè‡ªåŠ¨è¯»å–)
              # æˆ–è€…åœ¨å‘½ä»¤è¡Œæ˜¾å¼å¼•ç”¨ç¯å¢ƒå˜é‡
              
              echo "ğŸ”‘ DEBUG: Password length: ${#TAURI_KEY_PASSWORD}"
              echo "ğŸ”‘ DEBUG: Password value: $TAURI_KEY_PASSWORD"
              
              if [ -z "$TAURI_KEY_PASSWORD" ]; then
                echo "ğŸ“ Using key without password"
                cargo tauri signer sign \
                  "$INSTALLER" \
                  --private-key "$TAURI_PRIVATE_KEY"
              else
                echo "ğŸ“ Using key with password"
                cargo tauri signer sign \
                  "$INSTALLER" \
                  --private-key "$TAURI_PRIVATE_KEY" \
                  --password "$TAURI_KEY_PASSWORD"
              fi
              
              if [ -f "${INSTALLER}.sig" ]; then
                echo "âœ… Signature created: ${INSTALLER}.sig"
              else
                echo "âŒ Failed to create signature"
                exit 1
              fi
            fi
          done
          

          echo ""
          echo "ğŸ“‹ All files in bundle directory:"
          find "$BUNDLE_DIR" -type f

      # -------------------------
      # ğŸš€ ä¸Šä¼ åˆ°æ›´æ–°æœåŠ¡å™¨ (CI/CD è‡ªåŠ¨åŒ–)
      # -------------------------
      - name: Upload to update server
        if: matrix.platform != 'ubuntu-22.04'
        shell: bash
        run: |
          set -e
          echo "ğŸš€ Preparing to upload to update server..."

          # 1. ç¡®å®šç›®æ ‡å¹³å°åç§° (å¯¹åº” PHP æ¥å£è¦æ±‚)
          # aarch64-apple-darwin -> darwin-aarch64
          # x86_64-apple-darwin -> darwin-x86_64
          # x86_64-pc-windows-msvc -> windows-x86_64
          
          RAW_TARGET="${{ matrix.target }}"
          if [[ "$RAW_TARGET" == "aarch64-apple-darwin" ]]; then
            PLATFORM="darwin-aarch64"
          elif [[ "$RAW_TARGET" == "x86_64-apple-darwin" ]]; then
            PLATFORM="darwin-x86_64"
          elif [[ "$RAW_TARGET" == "x86_64-pc-windows-msvc" ]]; then
            PLATFORM="windows-x86_64"
          else
            echo "âš ï¸ Unknown target: $RAW_TARGET"
            PLATFORM="$RAW_TARGET"
          fi
          
          echo "ğŸ·ï¸ Platform: $PLATFORM"
          echo "ğŸ“¦ Version: ${{ github.ref_name }}"

          # 2. æ‰¾åˆ°è¦ä¸Šä¼ çš„æ–‡ä»¶å’Œç­¾å
          BUNDLE_DIR="src-tauri/target/$RAW_TARGET/release/bundle"
          
          if [[ "$PLATFORM" == darwin* ]]; then
            FILE_Path=$(find "$BUNDLE_DIR" -name "*.app.tar.gz" | head -n 1)
          else
            FILE_Path=$(find "$BUNDLE_DIR" -name "*.zip" | head -n 1)
          fi
          
          if [ -z "$FILE_Path" ]; then
            echo "âŒ No suitable file found to upload!"
            exit 1
          fi
          
          SIG_PATH="${FILE_Path}.sig"
          if [ ! -f "$SIG_PATH" ]; then
             echo "âŒ Signature file not found: $SIG_PATH"
             exit 1
          fi
          
          SIGNATURE=$(cat "$SIG_PATH")
          echo "ğŸ“„ File: $FILE_Path"
          echo "ğŸ” Signature length: ${#SIGNATURE}"
          
          # 3. è°ƒç”¨ API ä¸Šä¼ 
          # æ³¨æ„ï¼šè¿™é‡Œçš„ Token æ˜¯ç¡¬ç¼–ç çš„ï¼Œå»ºè®®åœ¨ Repository Secrets ä¸­é…ç½®å¹¶ä½¿ç”¨ ${{ secrets.CI_TOKEN }}
          API_URL="https://job3.posedu.cn/api/updater/upload_package"
          TOKEN="wlzj_ci_secret_888888" 
          
          echo "ğŸ“¡ Uploading to $API_URL ..."
          
          STATUS_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST "$API_URL" \
            -F "token=$TOKEN" \
            -F "version=${{ github.ref_name }}" \
            -F "platform=$PLATFORM" \
            -F "signature=$SIGNATURE" \
            -F "notes=Released via GitHub Actions" \
            -F "file=@$FILE_Path")
            
          echo "ğŸ“¡ Response code: $STATUS_CODE"
          cat response.json
          
          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "âœ… Upload and publish success!"
          else
            echo "âŒ Upload failed!"
            exit 1
          fi


      # -------------------------
      # ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
      # -------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-artifacts
          path: src-tauri/target/${{ matrix.target }}/release/bundle/**/*
          retention-days: 7
